openapi: 3.0.3
info:
  title: Chronosched API
  version: 1.0.0
servers:
- url: http://localhost:8080
paths:
  /healthz:
    get:
      summary: Health check
      responses:
        '200':
          description: Service healthy
          content:
            text/plain:
              schema:
                type: string
                example: ok
  /api/v1/namespaces:
    get:
      summary: List namespaces
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Namespace'
    post:
      summary: Create namespace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NamespaceCreateRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Namespace'
  /api/v1/namespace/{name}:
    parameters:
    - name: name
      in: path
      required: true
      schema:
        type: string
    get:
      summary: Get namespace
      responses:
        '200':
          description: Namespace
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Namespace'
    put:
      summary: Rename namespace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NamespaceRenameRequest'
      responses:
        '200':
          description: Renamed
          content:
            application/json:
              schema:
                type: object
                properties:
                  old:
                    type: string
                  new:
                    type: string
    delete:
      summary: Delete namespace
      responses:
        '204':
          description: Deleted
  /api/v1/dags/{namespace_id}:
    parameters:
    - name: namespace_id
      in: path
      required: true
      schema:
        type: string
    get:
      summary: List DAGs
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DAG'
    post:
      summary: Create DAGs (bulk)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/DAGCreateRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DAGCreateResponse'
    put:
      summary: Upsert DAGs (bulk)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/DAGCreateRequest'
      responses:
        '200':
          description: Upserted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
  /api/v1/dags/{namespace_id}/{id}:
    parameters:
    - name: namespace_id
      in: path
      required: true
      schema:
        type: string
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    get:
      summary: Get DAG
      responses:
        '200':
          description: DAG
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DAG'
    put:
      summary: Update DAG name
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
              required:
              - name
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DAG'
    delete:
      summary: Delete DAG
      responses:
        '204':
          description: Deleted
  /api/v1/definitions/{namespace_id}:
    parameters:
    - name: namespace_id
      in: path
      required: true
      schema:
        type: string
    get:
      summary: List definitions
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/JobDefinition'
    post:
      summary: Create definitions (bulk)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/JobDefinitionCreateRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
    put:
      summary: Upsert definitions (bulk)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/JobDefinitionCreateRequest'
      responses:
        '200':
          description: Upserted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
  /api/v1/definitions/{namespace_id}/{id}:
    parameters:
    - name: namespace_id
      in: path
      required: true
      schema:
        type: string
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    get:
      summary: Get definition
      responses:
        '200':
          description: Definition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobDefinition'
    put:
      summary: Create a new version of a definition
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobDefinitionCreateRequest'
      responses:
        '200':
          description: New version created
          content:
            application/json:
              schema:
                type: object
                properties:
                  old_def_id:
                    type: string
                    format: uuid
                  new_def_id:
                    type: string
                    format: uuid
                  namespace:
                    type: string
                  name:
                    type: string
                  new_version:
                    type: integer
    delete:
      summary: Soft-delete a specific definition version
      responses:
        '204':
          description: Deleted
  /api/v1/dags/{namespace_id}/{dagId}/jobs:
    parameters:
    - name: namespace_id
      in: path
      required: true
      schema:
        type: string
    - name: dagId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    get:
      summary: List jobs in DAG
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Job'
    post:
      summary: Create jobs (bulk)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/JobCreate'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
    put:
      summary: Upsert jobs (bulk)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/JobCreate'
      responses:
        '200':
          description: Upserted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
  /api/v1/dags/{namespace_id}/{dagId}/jobs/{id}:
    parameters:
    - name: namespace_id
      in: path
      required: true
      schema:
        type: string
    - name: dagId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    - name: id
      in: path
      required: true
      schema:
        type: integer
    get:
      summary: Get job by id (in DAG)
      responses:
        '200':
          description: Job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
    put:
      summary: Update mutable fields of a queued job
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                priority:
                  type: integer
                due_at:
                  type: string
                  format: date-time
                payload_json:
                  type: object
      responses:
        '204':
          description: Updated
    delete:
      summary: Cancel job (soft delete)
      responses:
        '204':
          description: Cancelled
  /api/v1/dags/{namespace_id}/{dagId}/dependencies:
    parameters:
    - name: namespace_id
      in: path
      required: true
      schema:
        type: string
    - name: dagId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    get:
      summary: List dependencies for a DAG or fetch a single dependency when parent_id and child_id are provided.
      parameters:
      - name: parent_id
        in: query
        required: false
        schema:
          type: integer
      - name: child_id
        in: query
        required: false
        schema:
          type: integer
      responses:
        '200':
          description: List of dependencies (or a single dependency when filtered by parent_id and child_id)
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/Dependency'
    post:
      summary: Create dependencies (bulk)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/DependencyCreateRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
    put:
      summary: Upsert dependencies (bulk)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/DependencyCreateRequest'
      responses:
        '200':
          description: Upserted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
    patch:
      summary: Update an individual dependency type
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DependencyCreateRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dependency'
    delete:
      summary: Delete an individual dependency (and archive it to history)
      parameters:
      - name: parent_id
        in: query
        required: true
        schema:
          type: integer
      - name: child_id
        in: query
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  dag_id:
                    type: string
                    format: uuid
                  parent_job_id:
                    type: integer
                  child_job_id:
                    type: integer
                  archived:
                    type: boolean
\n/api/v1/jobs/{namespace_id}/{jobId}/complete:
    parameters:
    - name: namespace_id
      in: path
      required: true
      schema:
        type: string
    - name: jobId
      in: path
      required: true
      schema:
        type: integer
    post:
      summary: Mark job complete
      responses:
        '204':
          description: Completed
  /api/v1/jobs/{namespace_id}/{jobId}/fail:
    parameters:
    - name: namespace_id
      in: path
      required: true
      schema:
        type: string
    - name: jobId
      in: path
      required: true
      schema:
        type: integer
    post:
      summary: Mark job failed
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FailRequest'
      responses:
        '204':
          description: Failed set
  /api/v1/admin/check/global-cycles:
    get:
      summary: Check global cycles across all DAGs
      responses:
        '200':
          description: Cycle check
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CycleCheckResponse'
components:
  schemas:
    NamespaceCreateRequest:
      type: object
      required:
      - name
      properties:
        name:
          type: string
          example: demo
    NamespaceRenameRequest:
      type: object
      required:
      - new_name
      properties:
        new_name:
          type: string
          example: prod
    Namespace:
      type: object
      properties:
        namespace_id:
          type: string
          format: uuid
          example: 4e8b2f8c-74a1-4c3e-97de-4f43eb3a0c9b
        name:
          type: string
          example: demo
    DAGCreateRequest:
      type: object
      required:
      - id
      - name
      properties:
        id:
          type: string
          format: uuid
          example: 2fd2fef5-3a9d-44e1-b5a2-34da5e58aeb3
        name:
          type: string
          example: nightly_etl
    DAG:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 2fd2fef5-3a9d-44e1-b5a2-34da5e58aeb3
        namespace:
          type: string
          example: demo
        name:
          type: string
          example: nightly_etl
        created_at:
          type: string
          format: date-time
          example: '2025-11-11T03:40:05Z'
    JobDefinitionCreateRequest:
      type: object
      required:
      - name
      - kind
      - payload_template
      properties:
        name:
          type: string
          example: ParentJob
        kind:
          type: string
          enum:
          - cmd
          - http
          - binary
          example: cmd
        payload_template:
          type: object
          example:
            cmd: echo hello
        cron_spec:
          type: string
          example: '@every 5s'
        delay_interval:
          type: string
          example: 5 minutes
    JobDefinition:
      type: object
      properties:
        def_id:
          type: string
          format: uuid
          example: c413e1f9-9127-47c5-bb77-f98aa1b3ec50
        namespace:
          type: string
          example: demo
        name:
          type: string
          example: ParentJob
        version:
          type: integer
          example: 1
        kind:
          type: string
          example: cmd
        payload_template:
          type: object
          example:
            cmd: echo hello
        cron_spec:
          type: string
          nullable: true
        delay_interval:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
          example: '2025-11-11T03:40:05Z'
        deleted:
          type: boolean          
    JobCreate:
      type: object
      required:
      - def_id
      properties:
        def_id:
          type: string
          format: uuid
          example: c413e1f9-9127-47c5-bb77-f98aa1b3ec50
        payload:
          type: string
          example: '{}'
        priority:
          type: integer
          example: 0
        due_at:
          type: string
          format: date-time
          example: '2025-11-11T04:10:00Z'
    Job:
      type: object
      properties:
        id:
          type: integer
          example: 101
        dag_id:
          type: string
          format: uuid
          example: 2fd2fef5-3a9d-44e1-b5a2-34da5e58aeb3
        def_id:
          type: string
          format: uuid
          example: c413e1f9-9127-47c5-bb77-f98aa1b3ec50
        status:
          type: string
          enum:
          - waiting
          - queued
          - running
          - succeeded
          - failed
          - cancelled
          example: queued
        kind:
          type: string
          example: cmd
        payload_json:
          type: object
          example:
            cmd: echo hello
        due_at:
          type: string
          format: date-time
          example: '2025-11-11T04:10:00Z'
    DependencyCreateRequest:
      type: object
      required:
      - ParentID
      - ChildID
      properties:
        ParentID:
          type: integer
          example: 101
        ChildID:
          type: integer
          example: 102
        dependency_type:
          type: string
          enum: [order-only, data]
          description: >
            If omitted, defaults to 'data'. When set to 'data', the child
            is assumed to consume data from the parent in addition to ordering
            semantics.
    DAGCreateResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "2fd2fef5-3a9d-44e1-b5a2-34da5e58aeb3"    
    Dependency:
      type: object
      properties:
        parent_job_id:
          type: integer
          example: 101
        child_job_id:
          type: integer
          example: 102
        dependency_type:
          type: string
          enum: [order-only, data]
          example: order-only
    FailRequest:
      type: object
      required:
      - error
      properties:
        error:
          type: string
          example: exit code 1
    CountResponse:
      type: object
      properties:
        count:
          type: integer
          example: 2
    CycleCheckResponse:
      type: object
      properties:
        count:
          type: integer
          example: 0
        results:
          type: array
          items:
            type: object
            properties:
              dag_id:
                type: string
                format: uuid
              cycles:
                type: array
                items:
                  type: array
                  items:
                    type: string
  /api/v1/admin/prune:
    post:
      summary: Prune archived entities into history tables
      description: >
        Move logically deleted or fully completed entities (job definitions, DAGs,
        jobs, and their dependencies) into history tables so that the active
        working set stays small. This operation is idempotent.
      responses:
        '200':
          description: Prune result with counts of archived rows.
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_definitions_archived:
                    type: integer
                  dags_archived:
                    type: integer
                  jobs_archived:
                    type: integer
                  dependencies_archived:
                    type: integer

